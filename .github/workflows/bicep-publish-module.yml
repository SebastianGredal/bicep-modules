name: Upload Changed Bicep Files

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
    id-token: write
    contents: write

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history

    - name: OIDC Login
      uses: azure/login@v1
      with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

    - name: Upload changed Bicep files
      run: |
        Import-Module -Name ./.github/scripts/PublishBicepModule.psm1
        if ("${{ github.event_name }}" -eq "push") {
          Publish-ChangedModule -fromCommit "HEAD~1" -toBranch 'main' -registryName ${{ secrets.CONTAINER_REGISTRY }} -documentationUri "https://github.com/SebastianGredal/bicep-modules"
        } elseif ("${{ github.event_name }}" -eq "pull_request") {
          Publish-ChangedModule -fromCommit "${{ github.event.pull_request.base.sha }}" -toCommit "${{ github.event.pull_request.head.sha }}" -registryName ${{ secrets.CONTAINER_REGISTRY }} -documentationUri "https://github.com/SebastianGredal/bicep-modules" -WhatIf
        }
      shell: pwsh